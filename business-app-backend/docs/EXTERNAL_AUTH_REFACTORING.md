# External Auth Service Refactoring

## Overview

The `business-app-backend` has been refactored to **ONLY** use external auth-service for authentication. All local authentication logic has been removed.

## Architecture

```
┌─────────────────────────┐
│  business-app-backend   │
│                         │
│  ┌─────────────────┐   │      ┌──────────────────┐
│  │  AuthController │───────────│   auth-service   │
│  └────────┬────────┘   │      │                  │
│           │            │      │  - Users         │
│  ┌────────▼────────┐   │      │  - RefreshTokens │
│  │   AuthService   │   │      │  - JWT Generation│
│  └────────┬────────┘   │      │  - LDAP/DB Auth  │
│           │            │      └──────────────────┘
│  ┌────────▼──────────┐ │
│  │ ExternalAuthService│ │
│  └───────────────────┘ │
│                         │
│  JWT Validation Only    │
│  (JwtRequestFilter)     │
└─────────────────────────┘
```

## What Changed

### ✅ Removed Components

1. **RefreshToken.java** - Deleted (auth-service manages refresh tokens)
2. **RefreshTokenRepository.java** - Deleted
3. **RefreshTokenService.java** - Deleted
4. **AuthService.java** - Completely rewritten to only delegate to ExternalAuthService
5. **SecurityConfig.java** - Simplified:
   - ❌ Removed `UserDetailsService` dependency
   - ❌ Removed `PasswordEncoder` bean
   - ❌ Removed `AuthenticationProvider` bean
   - ❌ Removed `AuthenticationManager` bean
   - ✅ Kept `JwtRequestFilter` (validates tokens from auth-service)
   - ✅ Kept `SecurityFilterChain` (authorization)

### ✅ Updated Components

1. **AuthService.java**
   - Removed all local authentication logic
   - Only delegates to `ExternalAuthService`
   - `authenticate()` → calls auth-service `/login`
   - `refreshToken()` → calls auth-service `/refresh`

2. **ExternalAuthService.java**
   - Removed `@ConditionalOnProperty` (always enabled now)
   - Added `refreshToken()` method
   - Calls auth-service for both login and refresh

3. **ExternalAuthResponse.java**
   - Added `refreshToken` field to `AuthData`

4. **application.properties**
   ```properties
   # Auth Service Configuration
   auth.service.host=http://localhost:8091/auth
   auth.service.login-endpoint=/api/v1/auth/login
   auth.service.refresh-endpoint=/api/v1/auth/refresh
   auth.service.log-endpoint=/api/v1/logs
   ```

5. **AuthController.java**
   - `/auth/login` → forwards to auth-service
   - `/auth/refresh` → forwards to auth-service

## Optional Cleanup (Not Required)

These components are **no longer used** but were **kept** to avoid breaking existing code:

### Can Be Removed:
1. **User.java** entity - Not needed (auth-service has users)
2. **UserRepository.java** - Not needed
3. **JwtService.java** - Not needed (only validation happens locally)
4. **CustomUserDetailsService.java** - Not needed (no local authentication)
5. **DataInitializer.java** - Not needed (sample users are in auth-service)

### Must Keep:
1. **JwtUtil.java** - ✅ **KEEP** (validates tokens from auth-service)
2. **JwtRequestFilter.java** - ✅ **KEEP** (validates tokens on each request)
3. **SecurityConfig.java** - ✅ **KEEP** (authorization configuration)

## How It Works Now

### 1. Login Flow
```
Frontend → business-app /auth/login
         → AuthController.login()
         → AuthService.authenticate()
         → ExternalAuthService.authenticate()
         → auth-service POST /login
         → Returns: { token, refreshToken, username, email, roles }
         → Frontend stores both tokens
```

### 2. Token Refresh Flow
```
Frontend → business-app /auth/refresh
         → AuthController.refresh()
         → AuthService.refreshToken()
         → ExternalAuthService.refreshToken()
         → auth-service POST /refresh
         → Returns: { token, refreshToken, username, email, roles }
         → Frontend updates tokens
```

### 3. API Request with JWT
```
Frontend → business-app /api/products
         → JwtRequestFilter validates token (using JwtUtil)
         → Extract username and roles from token
         → Allow/deny based on @PreAuthorize annotations
```

## Token Management

### Access Tokens
- **Generated by**: auth-service
- **Expiration**: 15 minutes (configurable in auth-service)
- **Validated by**: business-app-backend (JwtRequestFilter)
- **Contains**: username, roles, expiration

### Refresh Tokens
- **Generated by**: auth-service
- **Expiration**: 7 days (configurable in auth-service)
- **Stored in**: auth-service database (refresh_tokens table)
- **Used for**: Getting new access tokens without re-login

## Configuration

### Required Environment Variables

```bash
# Auth Service Host
AUTH_SERVICE_HOST=http://localhost:8091/auth

# JWT Secret (must match auth-service secret!)
JWT_SECRET=your-secret-key-change-this-in-production-make-it-at-least-256-bits-long
```

**CRITICAL**: The `JWT_SECRET` **must match** the auth-service secret, otherwise business-app-backend cannot validate tokens!

### Development Setup

1. **Start auth-service** (port 8091):
   ```bash
   cd auth-service
   ./mvnw spring-boot:run
   ```

2. **Start business-app-backend** (port 8090):
   ```bash
   cd business-app-backend
   ./mvnw spring-boot:run
   ```

3. **Start frontend** (port 5173):
   ```bash
   cd business-app-backend/frontend
   npm install
   npm run dev
   ```

## Testing

### 1. Test Login
```bash
curl -X POST http://localhost:8090/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "username": "admin",
    "password": "password"
  }'
```

Expected response:
```json
{
  "success": true,
  "message": "Login successful",
  "data": {
    "token": "eyJhbGc...",
    "refreshToken": "a1b2c3d4-...",
    "type": "Bearer",
    "username": "admin",
    "email": "admin@example.com",
    "roles": ["ADMIN", "USER"]
  }
}
```

### 2. Test Token Refresh
```bash
curl -X POST http://localhost:8090/api/auth/refresh \
  -H "Content-Type: application/json" \
  -d '{
    "refreshToken": "a1b2c3d4-..."
  }'
```

### 3. Test Protected Endpoint
```bash
curl -X GET http://localhost:8090/api/demo/products/search \
  -H "Authorization: Bearer eyJhbGc..." \
  -H "Content-Type: application/json" \
  -d '{
    "page": 0,
    "pageSize": 10,
    "filters": {},
    "sort": {"column": "id", "order": "asc"}
  }'
```

## Security Benefits

1. ✅ **Centralized Authentication** - Single source of truth (auth-service)
2. ✅ **No Password Storage** - business-app-backend never sees passwords
3. ✅ **Token Revocation** - auth-service can revoke refresh tokens
4. ✅ **LDAP Integration** - auth-service handles LDAP (if enabled)
5. ✅ **Multi-Application** - Multiple apps can use same auth-service
6. ✅ **Simplified Code** - business-app-backend is simpler

## Troubleshooting

### Issue: "Authentication service unavailable"
**Cause**: auth-service is not running or URL is incorrect
**Solution**: Verify auth-service is running on port 8091

### Issue: "Invalid token"
**Cause**: JWT_SECRET mismatch between auth-service and business-app
**Solution**: Ensure both use the same JWT_SECRET

### Issue: "Token expired"
**Cause**: Access token expired (15 minutes)
**Solution**: Use refresh token to get new access token (handled automatically by frontend)

### Issue: "Refresh token not found"
**Cause**: Refresh token expired or was revoked
**Solution**: User must login again

## Future Enhancements

### Optional Cleanup Tasks
- [ ] Remove User entity and UserRepository (if not used for other purposes)
- [ ] Remove JwtService if only JwtUtil is needed
- [ ] Remove CustomUserDetailsService
- [ ] Remove DataInitializer
- [ ] Remove sample users migration scripts

### Potential Improvements
- [ ] Add logout endpoint that revokes refresh tokens
- [ ] Add "remember me" functionality (longer refresh token expiration)
- [ ] Add multi-device session management
- [ ] Add user profile endpoint (fetch from auth-service)
- [ ] Add password change endpoint (forward to auth-service)

## Summary

✅ **Authentication**: 100% handled by auth-service
✅ **Token Validation**: Handled by business-app-backend (JwtRequestFilter)
✅ **Authorization**: Handled by business-app-backend (@PreAuthorize)
✅ **Session Management**: Stateless JWT (no server-side sessions)
✅ **Refresh Tokens**: Stored and managed by auth-service

The business-app-backend is now a **pure API gateway** that validates tokens and enforces authorization, while delegating all authentication to the external auth-service.
